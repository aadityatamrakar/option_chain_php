<html>

<head>
  <title>Option Chain Analysis</title>
</head>

<body>
  <div style="width:100%; height: 100%;" id="oiChgChart"></div>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    var optionChainData, lastUpdated, underlyingValue, selected_expiry, option_chain = [];
    google.charts.load('current', {
      packages: ['corechart', 'bar']
    });
    google.charts.setOnLoadCallback(init);

    function drawOIChgChart(context) {
      let headers = ['Strike Prices', 'Call OI Chg', 'Put OI Chg'];
      let values = context.option_chain.map(strike => {
        return [
          String(strike.strikePrice),
          parseInt(strike.CE.changeinOpenInterest),
          parseInt(strike.PE.changeinOpenInterest)
        ]
      });
      console.log([...headers, ...values]);
      var data = google.visualization.arrayToDataTable([headers, ...values]);

      var options = {
        chart: {
          title: 'Change in Open Interest',
          subtitle: '',
          legend: {
            position: 'none'
          }
        },
      };
      var chart = new google.charts.Bar(document.getElementById('oiChgChart'));
      chart.draw(data, google.charts.Bar.convertOptions(options));
    }

    function drawOIChart(context) {
      let headers = ['Strike Prices', 'Call OI', 'Put OI'];
      let values = context.option_chain.map(strike => {
        return [
          String(strike.strikePrice),
          parseInt(strike.CE.openInterest),
          parseInt(strike.PE.openInterest)
        ]
      });
      console.log([...headers, ...values]);
      var data = google.visualization.arrayToDataTable([headers, ...values]);

      var options = {
        chart: {
          title: 'Open Interest',
          subtitle: 'Underlying Value: ' + context.underlyingValue,
          legend: {
            position: 'none'
          }
        },
      };
      var chart = new google.charts.Bar(document.getElementById('oiChart'));
      chart.draw(data, google.charts.Bar.convertOptions(options));
    }

    function getData(cb) {
      return new Promise((resolve, reject) => {
        let currentTs = (new Date()).getTime();
        if (optionChainData != null) {
          resolve(optionChainData);
        } else {
          fetch('nifty.json?ts=' + currentTs, {cache: "no-store"})
            .then(resp => {
              if (resp.status != 200) throw new Error('something went wrong');
              return resp.json();
            })
            .then(data => {
              optionChainData = data;
              lastUpdated = data.records.timestamp;
              resolve(optionChainData);
            })
            .catch(err => {
              reject('error');
            })
        }
      });
    }

    function init() {
      getData().then(function (data) {
        expiryDates = data.records.expiryDates;
        underlyingValue = data.records.underlyingValue;
        selected_expiry = data.records.expiryDates[0];
        generateTbl();
      })
    }

    function generateContext() {
      let expiryDate = selected_expiry;
      let optionRange = 500;
      let option_chain = optionChainData.records.data.filter(c => {
        return (
            c.strikePrice <= optionRange + (parseInt(underlyingValue / 100) * 100)) &&
          (c.strikePrice >= (parseInt(underlyingValue / 100) * 100) - optionRange) &&
          c.expiryDate == expiryDate
      });

      option_chain = JSON.parse(JSON.stringify(option_chain)).map(optionChainAnalysis);

      let context = {
        option_chain,
        lastUpdated,
        underlyingValue,
        selected_expiry
      };

      console.log(context);
      return context;
    }

    function generateTbl() {
      let context = generateContext();
      drawOIChgChart(context);
      // drawOIChart(context);
      // renderTbl(context);
    }

    function fillExpiryDate(expiryDates) {
      let expirySelect = document.querySelector('#expiryDate');
      expirySelect.innerHTML = expiryDates.map((c, idx) => {
        return `<option value="${c}">${c}</option>`;
      });
    }

    function optionChainAnalysis(strike) {
      strike.CE.change = strike.CE.change ? strike.CE.change.toFixed(1) : '';
      strike.PE.change = strike.PE.change ? strike.PE.change.toFixed(1) : '';

      strike.PE.openInterest = String(strike.PE.openInterest).replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
      strike.CE.openInterest = String(strike.CE.openInterest).replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
      strike.PE.totalTradedVolume = String(strike.PE.totalTradedVolume).replace(/(\d)(?=(\d\d)+\d$)/g,
        "$1,");
      strike.CE.totalTradedVolume = String(strike.CE.totalTradedVolume).replace(/(\d)(?=(\d\d)+\d$)/g,
        "$1,");

      strike.CE_A = {};
      strike.PE_A = {};

      strike.CE_A.price = strike.CE.change > 0 ? 1 : 0;
      strike.CE_A.OI = strike.CE.changeinOpenInterest > 0 ? 1 : 0;

      strike.PE_A.price = strike.PE.change > 0 ? 1 : 0;
      strike.PE_A.OI = strike.PE.changeinOpenInterest > 0 ? 1 : 0;

      if (strike.CE_A.price === 0 && strike.CE_A.OI === 0) strike.CE_A.i = 'Long Liquidation';
      else if (strike.CE_A.price === 0 && strike.CE_A.OI === 1) strike.CE_A.i = 'Short Buildup';
      else if (strike.CE_A.price === 1 && strike.CE_A.OI === 1) strike.CE_A.i = 'Short Covering';
      else if (strike.CE_A.price === 1 && strike.CE_A.OI === 0) strike.CE_A.i = 'Long Buildup';

      if (strike.PE_A.price === 0 && strike.PE_A.OI === 0) strike.PE_A.i = 'Long Liquidation';
      else if (strike.PE_A.price === 0 && strike.PE_A.OI === 1) strike.PE_A.i = 'Short Buildup';
      else if (strike.PE_A.price === 1 && strike.PE_A.OI === 1) strike.PE_A.i = 'Short Covering';
      else if (strike.PE_A.price === 1 && strike.PE_A.OI === 0) strike.PE_A.i = 'Long Buildup';

      strike.PE_A.trend = (strike.PE_A.i == 'Long Liquidation' || strike.PE_A.i == 'Short Buildup') ?
        0 : 1;
      strike.CE_A.trend = (strike.CE_A.i == 'Long Liquidation' || strike.CE_A.i == 'Short Buildup') ?
        1 : 0;

      return strike;
    }

    function renderTbl(context) {
      var source = document.getElementById("chain").innerHTML;
      var template = Handlebars.compile(source);
      document.getElementById('content').innerHTML = template(context);
    }
  </script>
</body>

</html>